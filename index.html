<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Playing</title>
		<style>
			body {
				background-color: #363;
				background-image: url('https://i.ibb.co/9Zvz58h/star.png')
			}
			#video {
				display: none;
			}
			#snapshot {
				width: 100%;
			}
		</style>
	</head>
	<body>
		before
		afterwards
		there
		is
		always
		something
		around
		you

			<p><button id="start">Screenshot!</button>

			<video id="video" autoplay></video>
			<img id="snapshot" src="">
	</body>

	<script>
		const red = 0;
		const green = 1;
		const blue = 2;
		const alpha = 3;
		const videoElem = document.getElementById("video");
		const imageElem = document.getElementById("snapshot");
		const startElem = document.getElementById("start");

		const canvas = document.createElement("canvas");
		const context = canvas.getContext('2d');

		var displayMediaOptions = {
		video: {
			cursor: "none"
			},
			audio: false
		};

		// Set event listeners for the start and stop buttons
		startElem.addEventListener("click", function(evt) {
			console.log("start");
			startCapture();
		}, false);

		videoElem.addEventListener('play', function(evt) {
			console.log("play");
			const width = videoElem.videoWidth;
			const height = videoElem.videoWidth;
			canvas.width = width;
			canvas.height = height;

			context.drawImage(video, 0, 0);

			stopCapture();
			animate(width, height);

		}, false);

		function render(frame, width, height) {
			//console.log("render");
			const imageData = context.getImageData(0, 0, width, height);
			const pixels = imageData.data;

			for (let y = height-2; y >= 0; y--) {
				for (let x = 0; x < width; x++) {
					const index = ((y * width) + x) * 4;
					const below = (((1+y) * width) + x) * 4;

					if (!(
							pixels[index + red] +
							pixels[index + green] +
							pixels[index + blue] > 480))
						continue;

					if ((
							pixels[below + red] +
							pixels[below + green] +
							pixels[below + blue] > 480))
						continue;

					for (let part = 0; part < alpha; part++) {
						temp = pixels[index + part];
						pixels[index + part] = pixels[below + part];
						pixels[below + part] = temp;
					}
				}
			}

			context.putImageData(imageData, 0, 0);
			if (frames % 10 == 0) {
				imageElem.src = canvas.toDataURL("image/png");
			}
		}

		var frames = 0;
		function animate(width, height) {
			render(frames++, width, height);

			// animation loop
			window.requestAnimationFrame(() => animate(width, height));
		}

		async function startCapture() {
			console.log("starting capture");

			try {
				videoElem.srcObject = await navigator.mediaDevices
					.getDisplayMedia(displayMediaOptions);
			} catch(err) {
				console.error("Error: " + err);
			}
		}

		function stopCapture(evt) {
			if (!videoElem.srcObject) {
				return;
			}

			let tracks = videoElem.srcObject.getTracks();

			tracks.forEach(track => track.stop());
			videoElem.srcObject = null;
		}
	</script>
</html>

